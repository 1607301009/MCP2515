C51 COMPILER V9.60.0.0   MCP2515                                                           10/28/2021 00:33:29 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MCP2515
OBJECT MODULE PLACED IN .\Objects\MCP2515.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE MCP2515.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\List
                    -ings\MCP2515.lst) TABS(2) OBJECT(.\Objects\MCP2515.obj)

line level    source

   1          /**********************************************************************************
   2           * ÎÄ¼þÃû  £ºMCP2515.c
   3           * ÃèÊö    £ºMCP2515Çý¶¯º¯Êý¿â         
   4           * ÊµÑéÆ½Ì¨£ºNiRen_STC/IAP15ºËÐÄ°å(»òÓÃ»§STC15µ¥Æ¬»ú¿ª·¢°å) + NiRen_MCP2515 CANÄ£¿é    
   5          **********************************************************************************/
   6          
   7          #include <reg51.h>
   8          #include "MCP2515.H"
   9          
  10          //MCP2515Òý½Å¶¨Òå
  11          sbit MCP2515_INT  = P1^6;//MCP2515ÖÐ¶ÏÒý½Å    £¨ºÃÏñÃ»ÓÐÓÃµ½£©
  12          
  13          sbit MCP2515_SCK  = P1^5;//SPIÊ±ÖÓÒý½Å 
  14          sbit MCP2515_MOSI = P1^4;//SPIÖ÷»úÊä³ö´Ó»úÊäÈëÒý½Å 
  15          sbit MCP2515_MISO = P1^3;//SPIÖ÷»úÊäÈë´Ó»úÊä³öÒý½Å 
  16          sbit MCP2515_CS   = P1^2;//SPIÆ¬Ñ¡Òý½Å
  17          
  18          //uint8 code TXB0_Address[]={TXB0CTRL,TXB0SIDH,TXB0SIDL,TXB0EID8,TXB0EID0,TXB0DLC,TXB0D0,TXB0D1,TXB0D2,TXB
             -0D3,TXB0D4,TXB0D5,TXB0D6,TXB0D7};
  19          //uint8 code TXB1_Address[]={TXB1CTRL,TXB1SIDH,TXB1SIDL,TXB1EID8,TXB1EID0,TXB1DLC,TXB1D0,TXB1D1,TXB1D2,TXB
             -1D3,TXB1D4,TXB1D5,TXB1D6,TXB1D7};
  20          //uint8 code TXB2_Address[]={TXB2CTRL,TXB2SIDH,TXB2SIDL,TXB2EID8,TXB2EID0,TXB2DLC,TXB2D0,TXB2D1,TXB2D2,TXB
             -2D3,TXB2D4,TXB2D5,TXB2D6,TXB2D7};
  21          //
  22          //uint8 code RXF0_Address[]={RXF0SIDH,RXF0SIDL,RXF0EID8,RXF0EID0};
  23          //uint8 code RXF1_Address[]={RXF1SIDH,RXF1SIDL,RXF1EID8,RXF1EID0};
  24          //uint8 code RXF2_Address[]={RXF2SIDH,RXF2SIDL,RXF2EID8,RXF2EID0};
  25          //uint8 code RXF3_Address[]={RXF3SIDH,RXF3SIDL,RXF3EID8,RXF3EID0};
  26          //uint8 code RXF4_Address[]={RXF4SIDH,RXF4SIDL,RXF4EID8,RXF4EID0};
  27          //uint8 code RXF5_Address[]={RXF5SIDH,RXF5SIDL,RXF5EID8,RXF5EID0};
  28          //
  29          //uint8 code RXM0_Address[]={RXM0SIDH,RXM0SIDL,RXM0EID8,RXM0EID0};
  30          //uint8 code RXM1_Address[]={RXM1SIDH,RXM1SIDL,RXM1EID8,RXM1EID0};
  31          
  32          /*******************************************************************************
  33          * º¯ÊýÃû  : Delay_Nms
  34          * ÃèÊö    : Í¨¹ýÈí¼þÑÓÊ±Ô¼nms(²»×¼È·)
  35          * ÊäÈë    : x
  36          * ËµÃ÷    : ´Ë·½Ê½ÑÓÊ±Ê±¼äÊÇ²»×¼È·µÄ,×¼È·ÑÓÊ±½¨ÒéÓÃ¶¨Ê±Æ÷
  37          *******************************************************************************/
  38          void Delay_Nms(uint16 x)
  39          {
  40   1        uint16 y;
  41   1      
  42   1        for (;x>0;x--)
  43   1          for (y=0;y<100;y++);
  44   1      }
  45          
  46          
  47          /*******************************************************************************
  48          * º¯ÊýÃû  : SPI_ReadByte
  49          * ÃèÊö    : Í¨¹ýSPI¶ÁÈ¡Ò»¸ö×Ö½ÚÊý¾Ý
  50          * ÊäÈë    : ÎÞ
  51          * Êä³ö    : ÎÞ
C51 COMPILER V9.60.0.0   MCP2515                                                           10/28/2021 00:33:29 PAGE 2   

  52          * ·µ»ØÖµ  : rByte(¶ÁÈ¡µ½µÄÒ»¸ö×Ö½ÚÊý¾Ý)
  53          * ËµÃ÷    : ÎÞ
  54          *******************************************************************************/
  55          uint8 SPI_ReadByte(void)
  56          {
  57   1        uint8 i,rByte=0;
  58   1        
  59   1        MCP2515_SCK=0;
  60   1        for(i=0;i<8;i++)
  61   1        {
  62   2          MCP2515_SCK=1;
  63   2          rByte<<=1;
  64   2          rByte|=MCP2515_MISO;
  65   2          MCP2515_SCK=0;  
  66   2        }
  67   1        return rByte;
  68   1      }
  69          
  70          /*******************************************************************************
  71          * º¯ÊýÃû  : SPI_SendByte
  72          * ÃèÊö    : SPI·¢ËÍÒ»¸ö×Ö½ÚÊý¾Ý
  73          * ÊäÈë    : dt:´ý·¢ËÍµÄÊý¾Ý
  74          * Êä³ö    : ÎÞ
  75          * ·µ»ØÖµ  : ÎÞ
  76          * ËµÃ÷    : ÎÞ
  77          *******************************************************************************/
  78          void SPI_SendByte(uint8 dt)
  79          {
  80   1        uint8 i;
  81   1          
  82   1        for(i=0;i<8;i++)
  83   1        { 
  84   2          MCP2515_SCK=0;
  85   2          if((dt<<i)&0x80)
  86   2            MCP2515_MOSI=1;
  87   2          else
  88   2            MCP2515_MOSI=0;         
  89   2          MCP2515_SCK=1;
  90   2        }
  91   1        MCP2515_SCK=0;
  92   1      }
  93          
  94          /*******************************************************************************
  95          * º¯ÊýÃû  : MCP2515_WriteByte
  96          * ÃèÊö    : Í¨¹ýSPIÏòMCP2515Ö¸¶¨µØÖ·¼Ä´æÆ÷Ð´1¸ö×Ö½ÚÊý¾Ý
  97          * ÊäÈë    : addr:MCP2515¼Ä´æÆ÷µØÖ·,dat:´ýÐ´ÈëµÄÊý¾Ý
  98          * Êä³ö    : ÎÞ
  99          * ·µ»ØÖµ  : ÎÞ
 100          * ËµÃ÷    : ÎÞ
 101          *******************************************************************************/
 102          void MCP2515_WriteByte(uint8 addr,uint8 dat)
 103          {
 104   1        MCP2515_CS=0;       //ÖÃMCP2515µÄCSÎªµÍµçÆ½
 105   1        SPI_SendByte(CAN_WRITE);  //·¢ËÍÐ´ÃüÁî
 106   1        SPI_SendByte(addr);     //·¢ËÍµØÖ·
 107   1        SPI_SendByte(dat);      //Ð´ÈëÊý¾Ý
 108   1        MCP2515_CS=1;       //ÖÃMCP2515µÄCSÎª¸ßµçÆ½ 
 109   1      }
 110          
 111          /*******************************************************************************
 112          * º¯ÊýÃû  : MCP2515_ReadByte
 113          * ÃèÊö    : Í¨¹ýSPI´ÓMCP2515Ö¸¶¨µØÖ·¼ÄÆ÷¶Á1¸ö×Ö½ÚÊý¾Ý
C51 COMPILER V9.60.0.0   MCP2515                                                           10/28/2021 00:33:29 PAGE 3   

 114          * ÊäÈë    : addr:MCP2515¼Ä´æÆ÷µØÖ·
 115          * Êä³ö    : ÎÞ
 116          * ·µ»ØÖµ  : rByte:¶ÁÈ¡µ½¼Ä´æÆ÷µÄ1¸ö×Ö½ÚÊý¾Ý
 117          * ËµÃ÷    : ÎÞ
 118          *******************************************************************************/
 119          uint8 MCP2515_ReadByte(uint8 addr)
 120          {
 121   1        uint8 rByte;
 122   1        
 123   1        MCP2515_CS=0;       //ÖÃMCP2515µÄCSÎªµÍµçÆ½
 124   1        SPI_SendByte(CAN_READ);   //·¢ËÍ¶ÁÃüÁî
 125   1        SPI_SendByte(addr);     //·¢ËÍµØÖ·
 126   1        rByte=SPI_ReadByte();   //¶ÁÈ¡Êý¾Ý
 127   1        MCP2515_CS=1;       //ÖÃMCP2515µÄCSÎª¸ßµçÆ½
 128   1        return rByte;       //·µ»Ø¶Áµ½µÄÒ»¸ö×Ö½ÚÊý¾Ý
 129   1      }
 130          
 131          /*******************************************************************************
 132          * º¯ÊýÃû  : MCP2515_Reset
 133          * ÃèÊö    : ·¢ËÍ¸´Î»Ö¸ÁîÈí¼þ¸´Î»MCP2515
 134          * ÊäÈë    : ÎÞ
 135          * Êä³ö    : ÎÞ
 136          * ·µ»ØÖµ  : ÎÞ
 137          * ËµÃ÷    : ½«ÄÚ²¿¼Ä´æÆ÷¸´Î»ÎªÈ±Ê¡×´Ì¬,²¢½«Æ÷¼þÉè¶¨ÎªÅäÖÃÄ£Ê½
 138          *******************************************************************************/
 139          void MCP2515_Reset(void)
 140          {
 141   1        MCP2515_CS=0;       //ÖÃMCP2515µÄCSÎªµÍµçÆ½
 142   1        SPI_SendByte(CAN_RESET);  //·¢ËÍ¼Ä´æÆ÷¸´Î»ÃüÁî
 143   1        MCP2515_CS=1;       //ÖÃMCP2515µÄCSÎª¸ßµçÆ½
 144   1      }
 145          
 146          /*******************************************************************************
 147          * ÃèÊö    : ÉèÖÃ±¨ÎÄ½ÓÊÕÆÁ±ÎÆ÷RXMºÍ¹ýÂËÆ÷RXF¡¢·¢ËÍ»º³åÆ÷TXB ID
 148          * ÊäÈë    : ÆÁ±ÎÆ÷¡¢¹ýÂËÆ÷¡¢»º³åÆ÷ SIDHÊ×µØÖ·£» ID£¬ À©Õ¹±êÖ¾Î»
 149          * ·µ»ØÖµ  : ÎÞ
 150          * ËµÃ÷    : µ±ID>0x7FFÉèÖÃÉèÖÃÎªÍØÕ¹Ö¡
 151          *******************************************************************************/
 152          void CanSetID(uint8 Address, uint32 ID, bool EXIDE)
 153          {
 154   1          // EXIDE=1¡¢ID>0x7FFÉèÖÃÎ»ÍØÕ¹Ö¡
 155   1          if ((ID > 0x7FF) || EXIDE) {
 156   2              MCP2515_WriteByte(Address, ID >> 21);                      //SIDH
 157   2              MCP2515_WriteByte(Address + 1, (ID >> 18 & 0x07) << 5 | (ID >> 16 & 0x03) | 0x08);      //SIDL
 158   2              MCP2515_WriteByte(Address + 2, ID >> 8 & 0xFF);      //EID8
 159   2              MCP2515_WriteByte(Address + 3, ID & 0xFF);           //EID0
 160   2          } else {
 161   2              MCP2515_WriteByte(Address, ID >> 3);                      //SIDH
 162   2              MCP2515_WriteByte(Address + 1, (ID & 0x07) << 5);   //SIDL
 163   2              MCP2515_WriteByte(Address + 2, 0);                  //EID8
 164   2              MCP2515_WriteByte(Address + 3, 0);                  //EID0
 165   2          }
 166   1      }
 167          
 168          void Can_Init(CanCfgStruct *CanCfg)
 169          {
 170   1          MCP2515_Reset();    //·¢ËÍ¸´Î»Ö¸ÁîÈí¼þ¸´Î»MCP2515
 171   1          Delay_Nms(1);        //Í¨¹ýÈí¼þÑÓÊ±Ô¼nms(²»×¼È·)
 172   1      
 173   1          // ÉèÖÃ²¨ÌØÂÊ
 174   1          // set CNF1, SJW=00,³¤¶ÈÎª1TQ, BRP=49, TQ=[2*(BRP+1)]/Fsoc=2*50/8M=12.5us
 175   1          MCP2515_WriteByte(CNF1, CanCfg->bitrate[4] | CanCfg->bitrate[0]);
C51 COMPILER V9.60.0.0   MCP2515                                                           10/28/2021 00:33:29 PAGE 4   

 176   1          // set CNF2, SAM=0,ÔÚ²ÉÑùµã¶Ô×ÜÏß½øÐÐÒ»´Î²ÉÑù£¬PHSEG1=(2+1)TQ=3TQ, PRSEG=(0+1)TQ=1TQ
 177   1          MCP2515_WriteByte(CNF2, BTLMODE_CNF3 | CanCfg->bitrate[2] | CanCfg->bitrate[1]);
 178   1          // set CNF3, PHSEG2=(2+1)TQ=3TQ,Í¬Ê±µ±CANCTRL.CLKEN=1Ê±Éè¶¨CLKOUTÒý½ÅÎªÊ±¼äÊä³öÊ¹ÄÜÎ»
 179   1          MCP2515_WriteByte(CNF3, SOF_ENABLED | CanCfg->bitrate[3]);
 180   1      
 181   1          MCP2515_WriteByte(RXB0CTRL, CanCfg->BUKT_enable << 2);  // Èç¹ûRXB0Âú,RXB0 ½ÓÊÕµ½µÄ±¨ÎÄ½«±»¹ö´æÖÁRXB1
 182   1      
 183   1          MCP2515_WriteByte(RXB1CTRL, RXM);  // ½ÓÊÕËùÓÐ±¨ÎÄ
 184   1      
 185   1          MCP2515_WriteByte(CANINTF, CanCfg->CANINTF_enable);  // Çå¿ÕCANÖÐ¶Ï±êÖ¾¼Ä´æÆ÷µÄËùÓÐÎ»(±ØÐëÓÉMCUÇå¿Õ)
 186   1          MCP2515_WriteByte(CANINTE, CanCfg->CANINTE_enable);  // ÅäÖÃCANÖÐ¶ÏÊ¹ÄÜ¼Ä´æÆ÷µÄ½ÓÊÕ»º³åÆ÷0ÂúÖÐ¶ÏÊ¹ÄÜ,Æ
             -äËüÎ»½ûÖ¹ÖÐ¶Ï
 187   1      
 188   1          // ÉèÖÃÑéÊÕÂË²¨Æ÷
 189   1          CanSetID(RXF0SIDH, CanCfg->RXF0ID, CanCfg->RXF0IDE);
 190   1          CanSetID(RXF1SIDH, CanCfg->RXF1ID, CanCfg->RXF1IDE);
 191   1          CanSetID(RXF2SIDH, CanCfg->RXF2ID, CanCfg->RXF2IDE);
 192   1          CanSetID(RXF3SIDH, CanCfg->RXF3ID, CanCfg->RXF3IDE);
 193   1          CanSetID(RXF4SIDH, CanCfg->RXF4ID, CanCfg->RXF4IDE);
 194   1          CanSetID(RXF5SIDH, CanCfg->RXF5ID, CanCfg->RXF5IDE);
 195   1          // ÉèÖÃÑéÊÕÆÁ±ÎÆ÷
 196   1          CanSetID(RXM0SIDH, CanCfg->RXM0ID, 1);
 197   1          CanSetID(RXM1SIDH, CanCfg->RXM1ID, 1);
 198   1      
 199   1          MCP2515_WriteByte(CANCTRL, REQOP_LOOPBACK | CLKOUT_ENABLED);//½«MCP2515ÉèÖÃÎª»·»ØÄ£Ê½,ÍË³öÅäÖÃÄ£Ê½
 200   1          if (OPMODE_NORMAL != (MCP2515_ReadByte(CANSTAT) && 0xE0))//ÅÐ¶ÏMCP2515ÊÇ·ñÒÑ¾­½øÈë»·»ØÄ£Ê½
 201   1          {
 202   2              MCP2515_WriteByte(CANCTRL, REQOP_LOOPBACK | CLKOUT_ENABLED);//ÔÙ´Î½«MCP2515ÉèÖÃÎª»·»ØÄ£Ê½,ÍË³öÅäÖÃ
             -Ä£Ê½
 203   2          }
 204   1      }
 205          
 206          /*******************************************************************************
 207          * º¯ÊýÃû  : MCP2515_Init
 208          * ÃèÊö    : MCP2515³õÊ¼»¯ÅäÖÃ
 209          * ÊäÈë    : ÎÞ
 210          * Êä³ö    : ÎÞ
 211          * ·µ»ØÖµ  : ÎÞ
 212          * ËµÃ÷    : ³õÊ¼»¯°üÀ¨£ºÈí¼þ¸´Î»¡¢¹¤×÷²¨ÌØÂÊÉèÖÃ¡¢±êÊ¶·ûÏà¹ØÅäÖÃµÈ¡£
 213          *******************************************************************************/
 214          //void MCP2515_Init(uint8 *CAN_Bitrate)
 215          //{
 216          //  uint8 temp=0;
 217          //
 218          //  MCP2515_Reset();  //·¢ËÍ¸´Î»Ö¸ÁîÈí¼þ¸´Î»MCP2515
 219          //  Delay_Nms(1);   //Í¨¹ýÈí¼þÑÓÊ±Ô¼nms(²»×¼È·)
 220          //
 221          //  //ÉèÖÃ²¨ÌØÂÊ
 222          //  //set CNF1,SJW=00,³¤¶ÈÎª1TQ,BRP=49,TQ=[2*(BRP+1)]/Fsoc=2*50/8M=12.5us
 223          //  MCP2515_WriteByte(CNF1,CAN_Bitrate[4]|CAN_Bitrate[0]);
 224          //  //set CNF2,SAM=0,ÔÚ²ÉÑùµã¶Ô×ÜÏß½øÐÐÒ»´Î²ÉÑù£¬PHSEG1=(2+1)TQ=3TQ,PRSEG=(0+1)TQ=1TQ
 225          //  MCP2515_WriteByte(CNF2,BTLMODE_CNF3|CAN_Bitrate[2]|CAN_Bitrate[1]);
 226          //  //set CNF3,PHSEG2=(2+1)TQ=3TQ,Í¬Ê±µ±CANCTRL.CLKEN=1Ê±Éè¶¨CLKOUTÒý½ÅÎªÊ±¼äÊä³öÊ¹ÄÜÎ»
 227          //  MCP2515_WriteByte(CNF3,SOF_ENABLED|CAN_Bitrate[3]);
 228          //
 229          //  MCP2515_WriteByte(RXB0CTRL,0x06);//Èç¹ûRXB0Âú,RXB0 ½ÓÊÕµ½µÄ±¨ÎÄ½«±»¹ö´æÖÁRXB1
 230          //
 231          //  //uint8 RXF_Address,uint32 ID,uint8 EXIDE)
 232          //  //RXB0 ½ÓÊÕ»º³åÆ÷Åä±¸ÓÐÑéÊÕÂË²¨¼Ä´æÆ÷RXF0 ºÍRXF1£¨ÒÔ¼°¹ýÂËÆÁ±Î¼Ä´æÆ÷RXM0£©
 233          //  CanSetID(RXF0SIDH,0x100,1);
 234          //  CanSetID(RXF1SIDH,0x7FE,0);
 235          //
C51 COMPILER V9.60.0.0   MCP2515                                                           10/28/2021 00:33:29 PAGE 5   

 236          //  CanSetID(RXM0SIDH,0x7FF,0);
 237          //
 238          //  //RXB1 Åä±¸ÓÐÑéÊÕÂË²¨¼Ä´æÆ÷RXF2¡¢RXF3¡¢RXF4¡¢RXF5ºÍÂË²¨ÆÁ±Î¼Ä´æÆ÷RXM1¡£
 239          //  CanSetID(RXF2SIDH,0x800,1);
 240          //  CanSetID(RXF3SIDH,0x1FFFFFFF,1);
 241          //  CanSetID(RXF4SIDH,0x7FF,0);
 242          //  CanSetID(RXF5SIDH,0x0,0);
 243          //
 244          //  CanSetID(RXM1SIDH,0x1FFFFFFE,0);
 245          //
 246          ////  MCP2515_WriteByte(TXB0SIDH,0xAB);//·¢ËÍ»º³åÆ÷0±ê×¼±êÊ¶·û¸ßÎ»
 247          ////  MCP2515_WriteByte(TXB0SIDL,0xE0);//|0x08|0x2);//·¢ËÍ»º³åÆ÷0±ê×¼±êÊ¶·ûµÍÎ»
 248          ////  MCP2515_WriteByte(TXB0EID8,0x00);//·¢ËÍ»º³åÆ÷0±ê×¼±êÊ¶·û¸ßÎ»
 249          ////  MCP2515_WriteByte(TXB0EID0,0x00);//·¢ËÍ»º³åÆ÷0±ê×¼±êÊ¶·ûµÍÎ»
 250          ////
 251          ////
 252          ////  MCP2515_WriteByte(RXB0SIDH,0x00);//Çå¿Õ½ÓÊÕ»º³åÆ÷0µÄ±ê×¼±êÊ¶·û¸ßÎ»
 253          ////  MCP2515_WriteByte(RXB0SIDL,0x00);//Çå¿Õ½ÓÊÕ»º³åÆ÷0µÄ±ê×¼±êÊ¶·ûµÍÎ»
 254          ////
 255          ////  MCP2515_WriteByte(RXB0CTRL,0x62);//½ö½ö½ÓÊÕ±ê×¼±êÊ¶·ûµÄÓÐÐ§ÐÅÏ¢
 256          ////  MCP2515_WriteByte(RXB0DLC,DLC_8);//ÉèÖÃ½ÓÊÕÊý¾ÝµÄ³¤¶ÈÎª8¸ö×Ö½Ú
 257          ////
 258          ////  MCP2515_WriteByte(RXF0SIDH,0xFF);       //ÅäÖÃÑéÊÕÂË²¨¼Ä´æÆ÷n±ê×¼±êÊ¶·û¸ßÎ»
 259          ////
 260          ////  MCP2515_WriteByte(RXM0SIDH,0xFF);       //ÅäÖÃÑéÊÕÆÁ±Î¼Ä´æÆ÷n±ê×¼±êÊ¶·û¸ßÎ»
 261          ////  MCP2515_WriteByte(RXM1EID0,0xE0);       //ÅäÖÃÑéÊÕÆÁ±Î¼Ä´æÆ÷n±ê×¼±êÊ¶·ûµÍÎ»
 262          ////
 263          //  MCP2515_WriteByte(CANINTF,0x00);    //Çå¿ÕCANÖÐ¶Ï±êÖ¾¼Ä´æÆ÷µÄËùÓÐÎ»(±ØÐëÓÉMCUÇå¿Õ)
 264          //  MCP2515_WriteByte(CANINTE,0x03);    //ÅäÖÃCANÖÐ¶ÏÊ¹ÄÜ¼Ä´æÆ÷µÄ½ÓÊÕ»º³åÆ÷ÂúÖÐ¶ÏÊ¹ÄÜ,ÆäËüÎ»½ûÖ¹ÖÐ¶Ï
 265          //
 266          ////  MCP2515_WriteByte(CANCTRL,REQOP_LOOPBACK|CLKOUT_ENABLED);//|OSM_ENABLED½«MCP2515ÉèÖÃÎªÕý³£Ä£Ê½,ÍË³öÅä
             -ÖÃÄ£Ê½
 267          ////
 268          ////  temp=MCP2515_ReadByte(CANSTAT);//¶ÁÈ¡CAN×´Ì¬¼Ä´æÆ÷µÄÖµ
 269          ////  if(OPMODE_LOOPBACK!=(temp&&0xE0))//ÅÐ¶ÏMCP2515ÊÇ·ñÒÑ¾­½øÈëÕý³£Ä£Ê½
 270          ////  {
 271          ////      MCP2515_WriteByte(CANCTRL,REQOP_LOOPBACK|CLKOUT_ENABLED);//|OSM_ENABLEDÔÙ´Î½«MCP2515ÉèÖÃÎªÕý³£Ä£Ê
             -½,ÍË³öÅäÖÃÄ£Ê½
 272          ////  }
 273          //
 274          //    MCP2515_WriteByte(CANCTRL,REQOP_LOOPBACK|CLKOUT_ENABLED);//½«MCP2515ÉèÖÃÎª»·»ØÄ£Ê½,ÍË³öÅäÖÃÄ£Ê½
 275          //
 276          //    temp=MCP2515_ReadByte(CANSTAT);//¶ÁÈ¡CAN×´Ì¬¼Ä´æÆ÷µÄÖµ
 277          //    if(OPMODE_NORMAL!=(temp&&0xE0))//ÅÐ¶ÏMCP2515ÊÇ·ñÒÑ¾­½øÈë»·»ØÄ£Ê½
 278          //    {
 279          //    MCP2515_WriteByte(CANCTRL,REQOP_LOOPBACK|CLKOUT_ENABLED);//ÔÙ´Î½«MCP2515ÉèÖÃÎª»·»ØÄ£Ê½,ÍË³öÅäÖÃÄ£Ê½
 280          //    }
 281          //
 282          //}
 283          
 284          /*******************************************************************************
 285          * º¯ÊýÃû  : CAN_Send_Buffer
 286          * ÃèÊö    : CAN·¢ËÍÖ¸¶¨³¤¶ÈµÄÊý¾Ý
 287          * ÊäÈë    : *CAN_TX_Buf(´ý·¢ËÍÊý¾Ý»º³åÇøÖ¸Õë),len(´ý·¢ËÍÊý¾Ý³¤¶È)
 288          * Êä³ö    : ÎÞ
 289          * ·µ»ØÖµ  : ÎÞ
 290          * ËµÃ÷    :
 291          * ¸Ä½øµã   £ºÔÚ±¨ÎÄ·¢ËÍÖ®Ç°£¬ MCU Ó¦¶ÔCANINTE.TXInE Î»½øÐÐ³õÊ¼»¯£¬ÒÔ±ãÔÚ±¨ÎÄ·¢ËÍÊ±Ê¹ÄÜ»ò½ûÖ¹ÖÐ¶ÏµÄ²úÉú
 292           *          ÔÚÐ´Èë·¢ËÍ»º³åÆ÷Ö®Ç°£¬±ØÐë½«TXBnCTRL.TXREQ Î»ÇåÁã£¨±íÃ÷·¢ËÍ»º³åÆ÷ÎÞµÈ´ý·¢ËÍµÄ±¨ÎÄ£©¡£
 293          *******************************************************************************/
 294          void CAN_Send_buffer(uint32 ID,uint8 EXIDE,uint8 DLC,uint8 *Send_data)
 295          {
C51 COMPILER V9.60.0.0   MCP2515                                                           10/28/2021 00:33:29 PAGE 6   

 296   1        uint8 TXBnCTRL;         // Ñ¡Ôñ·¢ËÍ»º³åÆ÷
 297   1      
 298   1          uint8 i;
 299   1        //¼Ä´æÆ÷×´Ì¬»ñÈ¡TXB0ÊÇ·ñÃ¦Âµ£¬1ÎªÃ¦Âµ£¬0Îª¿ÕÏÐ
 300   1        uint8 Read_TXBnCTRL = MCP2515_ReadByte(TXB0CTRL);
 301   1        if ((Read_TXBnCTRL & TXREQ) == 0)
 302   1        {
 303   2            TXBnCTRL = TXB0CTRL;
 304   2        }
 305   1        else
 306   1        {
 307   2            Read_TXBnCTRL = MCP2515_ReadByte(TXB1CTRL);
 308   2            if ((Read_TXBnCTRL & TXREQ) == 0)
 309   2            {
 310   3                TXBnCTRL = TXB1CTRL;
 311   3            }
 312   2            else
 313   2            {
 314   3                Read_TXBnCTRL = MCP2515_ReadByte(TXB2CTRL);  // Èç¹ûÇ°ÃæÁ½¸ö¼Ä´æÆ÷È«²¿Ã¦Âµ£¬ Ä¬ÈÏÊ¹ÓÃµÚ3¸ö
 315   3                TXBnCTRL = TXB2CTRL;
 316   3            }
 317   2        }
 318   1      
 319   1        // ÉèÖÃDLC£¬ Ä¬ÈÏÎªÊý¾ÝÖ¡ RTR=0   ºóÆÚ¿ª·¢Ô¶³ÌÖ¡
 320   1        MCP2515_WriteByte(TXBnCTRL + 5, DLC);
 321   1          CanSetID(TXBnCTRL + 1, ID, EXIDE);
 322   1        // EXIDE=1¡¢ID>0x7FF·¢ËÍÍØÕ¹Ö¡
 323   1      //  if (ID<=0x7FF)
 324   1      //  {
 325   1      //    if (EXIDE)
 326   1      //    {
 327   1      //        MCP2515_WriteByte(TXBnCTRL + 1, 0x0);     //SIDH
 328   1      //        MCP2515_WriteByte(TXBnCTRL + 2, 0x8);     //SIDL
 329   1      //        MCP2515_WriteByte(TXBnCTRL + 3, ID>>8&0xFF);  //EID8
 330   1      //            MCP2515_WriteByte(TXBnCTRL + 4, ID&0xFF);   //EID0
 331   1      //    }
 332   1      //    else
 333   1      //    {
 334   1      //        MCP2515_WriteByte(TXBnCTRL + 1, ID>>3);     //SIDH
 335   1      //        MCP2515_WriteByte(TXBnCTRL + 2, (ID&0x07)<<5);  //SIDL
 336   1      //        MCP2515_WriteByte(TXBnCTRL + 3, 0);       //EID8
 337   1      //        MCP2515_WriteByte(TXBnCTRL + 4, 0);       //EID0
 338   1      //    }
 339   1      //  }
 340   1      //  else
 341   1      //  {
 342   1      //      MCP2515_WriteByte(TXBnCTRL + 1, ID>>21);                  //SIDH
 343   1      //      MCP2515_WriteByte(TXBnCTRL + 2, (ID>>18&0x07)<<5|(ID>>16&0x03)|0x08);   //SIDL
 344   1      //      MCP2515_WriteByte(TXBnCTRL + 3, ID>>8&0xFF);                //EID8
 345   1      //      MCP2515_WriteByte(TXBnCTRL + 4, ID&0xFF);                 //EID0
 346   1      //  }
 347   1        
 348   1        for(i = 0;(i <= DLC && i <= 8); i++)
 349   1        {
 350   2            MCP2515_WriteByte(TXBnCTRL + 6 + i, Send_data[i]);              //D0_8½«´ý·¢ËÍµÄÊý¾ÝÐ´Èë·¢ËÍ»º³å¼Ä´æÆ÷
 351   2        }
 352   1      
 353   1        MCP2515_CS=0;
 354   1        MCP2515_WriteByte(TXBnCTRL, Read_TXBnCTRL | TXREQ); //CTRL ¿ªÊ¼·¢ËÍ
 355   1        MCP2515_CS=1;
 356   1        //·¢ËÍÐÎÊ½ÉèÖÃ£ºµ¥´Î·¢ËÍ£¬Ô¶³ÌÖ¡£¬ÍØÕ¹Ö¡£¬µ÷ÊÔ×´Ì¬£¬»ØÓ¦¡£
 357   1      
C51 COMPILER V9.60.0.0   MCP2515                                                           10/28/2021 00:33:29 PAGE 7   

 358   1          // µÈ´ý±¨ÎÄ·¢ËÍ³É¹¦
 359   1          for(i = 0; i < 14; i++)
 360   1          {
 361   2              if ((MCP2515_ReadByte(TXBnCTRL) & TXREQ) == 0)
 362   2              {
 363   3                  return;
 364   3              }
 365   2              Delay_Nms(100);
 366   2          }
 367   1      }
 368          
 369          /*******************************************************************************
 370          * º¯ÊýÃû  : CAN_Receive_Buffer
 371          * ÃèÊö    : CAN½ÓÊÕÒ»Ö¡Êý¾Ý
 372          * ÊäÈë    : RX_Address(ÐèÒª¶ÁÈ¡µÄRXB0CTRL¡¢RXB1CTRLµØÖ·),*CAN_TX_Buf(´ý½ÓÊÕÊý¾Ý»º³åÇøÖ¸Õë)
 373          * Êä³ö    : ÎÞ
 374          * ·µ»ØÖµ  : len(½ÓÊÕµ½Êý¾ÝµÄ³¤¶È,0~8×Ö½Ú)
 375          * ËµÃ÷    : ÎÞ
 376          *******************************************************************************/
 377          void CAN_Receive_Buffer(uint8 RXB_CTRL_Address,uint8 *CAN_RX_Buf)
 378          { 
 379   1        uint8 j;
 380   1        for(j=0;j<14;j++)
 381   1        {
 382   2          CAN_RX_Buf[j]=MCP2515_ReadByte(RXB_CTRL_Address+j);//°ÑCAN½ÓÊÕµ½µÄÊý¾Ý·ÅÈëÖ¸¶¨»º³åÇø
 383   2          //CAN_RX_Buf[j]=RXB_CTRL_Address+j;
 384   2        }
 385   1        if (RXB_CTRL_Address==RXB0CTRL)
 386   1          {
 387   2          MCP2515_WriteByte(CANINTF,0);//Çå³ýÖÐ¶Ï±êÖ¾Î»(ÖÐ¶Ï±êÖ¾¼Ä´æÆ÷±ØÐëÓÉMCUÇåÁã)
 388   2          }
 389   1        else if (RXB_CTRL_Address==RXB1CTRL)
 390   1          {
 391   2          MCP2515_WriteByte(CANINTF,0);//Çå³ýÖÐ¶Ï±êÖ¾Î»(ÖÐ¶Ï±êÖ¾¼Ä´æÆ÷±ØÐëÓÉMCUÇåÁã)  
 392   2          }
 393   1      }
 394          
 395          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1294    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----      24
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
